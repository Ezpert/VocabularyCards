<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/viewCard.css' %}">
     <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>
<body>
    <svg style="display: none;">
        <symbol id="arrow-left" viewBox="0 0 24 24">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M19.9961 11.0076L6.99614 11.0076L12.5627 5.10988C13.0638 4.49442 13.1469 3.81523 12.6791 3.33739C12.2268 2.87542 11.4963 2.89791 11.044 3.35988L3.33994 11.1802C2.88766 11.6422 2.88766 12.3884 3.33994 12.8504L11.0324 20.6539C11.4847 21.1159 12.2077 21.1111 12.69 20.6803C13.188 20.2354 13.0048 19.4402 12.5667 18.9341L6.99614 13.0084H19.9961C20.634 13.0084 20.9961 12.652 20.9961 12.0005C20.9961 11.349 20.634 11.0076 19.9961 11.0076Z"></path>
        </symbol>
        <symbol id="arrow-right" viewBox="0 0 24 24">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M4.00098 12.9963H17.001L11.4344 18.894C10.9333 19.5095 10.8502 20.1887 11.318 20.6665C11.7703 21.1285 12.5009 21.106 12.9531 20.644L20.6572 12.8237C21.1095 12.3618 21.1095 11.6155 20.6572 11.1536L12.9647 3.34999C12.5125 2.88802 11.7894 2.89278 11.3071 3.32361C10.8091 3.76851 10.9923 4.56372 11.4305 5.06982L17.001 10.9955L4.00098 10.9955C3.36316 10.9955 3.00098 11.3519 3.00098 12.0034C3.00098 12.6549 3.36316 12.9963 4.00098 12.9963Z"></path>
        </symbol>
        <symbol id="star-empty" viewBox="0 0 24 24">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M20.0432 9.02445L14.9534 8.56251L12.9659 3.66816C12.6084 2.77728 11.3885 2.77728 11.031 3.66816L9.04348 8.57351L3.96427 9.02445C3.03886 9.10144 2.66029 10.3113 3.36486 10.9492L7.22422 14.4467L6.06746 19.638C5.85714 20.5839 6.83513 21.3318 7.63434 20.8259L11.9985 18.0762L16.3626 20.8369C17.1618 21.3428 18.1398 20.5949 17.9295 19.649L16.7727 14.4467L20.6321 10.9492C21.3366 10.3113 20.9686 9.10144 20.0432 9.02445ZM11.9985 16.0195L8.04446 18.5162L9.09606 13.8088L5.60476 10.6412L10.2107 10.2233L11.9985 5.79086L13.7967 10.2343L18.4027 10.6522L14.9114 13.8198L15.963 18.5272L11.9985 16.0195Z" fill="#586380"></path>
        </symbol>
        <symbol id="star-filled" viewBox="0 0 24 24">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 18.0745L16.3649 20.8368C17.1642 21.343 18.1424 20.5947 17.932 19.6482L16.7751 14.4537L20.6351 10.9541C21.3398 10.3157 20.9611 9.10517 20.0356 9.02813L14.9555 8.57692L12.9676 3.66857C12.61 2.77714 11.39 2.77714 11.0324 3.66857L9.04451 8.56591L3.96443 9.01713C3.03887 9.09416 2.66023 10.3047 3.36492 10.943L7.22494 14.4427L6.06799 19.6372C5.85763 20.5837 6.83578 21.332 7.63513 20.8258L12 18.0745Z"></path>
        </symbol>
        <symbol viewBox="0 0 24 24" id="edit" xmlns="http://www.w3.org/2000/svg">
            <path d="M3.439 17.901a.917.917 0 0 1 .249-.46L15.59 5.54l2.871 2.87L6.56 20.313a.918.918 0 0 1-.46.25l-1.992.418a.918.918 0 0 1-1.087-1.087l.419-1.992ZM17.591 3.538l-.901.901L19.56 7.31l.901-.901a1.835 1.835 0 0 0 0-2.596l-.275-.275a1.835 1.835 0 0 0-2.596 0Z"></path>
        </symbol>
        <symbol viewBox="0 0 24 24" id="garbage" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.009 9.002V20H6.999V9.002h10.01Zm-1.716-6.71A1 1 0 0 0 14.586 2H9.414a1 1 0 0 0-.707.293L8 3H4a1 1 0 0 0 0 2h16a1 1 0 1 0 0-2h-4l-.707-.707ZM19 8a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1v11.778C5 21 6.443 22 7.857 22h8.286C17.557 22 19 21 19 19.778V8Z"></path>
        </symbol>
    </svg>


    {% load my_filters %}

    <div class="container" >

    <form class="back-button-form" action="{% url 'viewCards' %}" method="get">
            <button class="back-button" type="submit">
                <svg id="back-button-svg" class="svg-class">
                    <use xlink:href="#arrow-left"/>
                </svg>
            </button>
    </form>

        {% if card %}

         <div id="success-message" style="display: none;"></div>



        <div class="def-div" id="definition-div">

            <div id="definitionCarousel">

                <ol class="ordered-list-div">

                    <div class="info-header-div">
                        <p id="card" style="display:none;">{{ card }}</p>
                        <h2 contenteditable="false" id="word-text" >{{ card.word }}</h2>
                    </div>

                    {% for definition in card.definitions.all %}
                        <li id="definition-{{ definition.id }}" style="display: none;">
                            <p contenteditable="false" id="def-text-{{ definition.id }}">
                                {{ definition.definition_text|remove:"(for riveting)" }}
                            </p>
                            <p contenteditable="false" id="sentence-use-{{ definition.id }}" style="font-style: italic;">
                                {% if definition.sentence_use and definition.sentence_use != "No example provided" %}
                                    {{definition.sentence_use}}
                                {% elif definition.sentence_use == "No example provided" %}
                                    {{definition.sentence_use}}
                                {% endif %}
                            </p>
                        </li>
                    {% endfor %}
                </ol>

            </div>


            <input type="hidden" id="currentDefinitionId" value="">

        <div class="nav-div">
                <button class="nav-buttons hover-effect"id="prevBtn">
                    <svg class="svg-class">
                      <use xlink:href="#arrow-left" />
                    </svg>
                </button>
                <h4 id="counter">0  / {{ definitions_and_examples|length }}</h4>
                <button class="nav-buttons hover-effect" id="nextBtn">
                    <svg class="svg-class">
                        <use xlink:href="#arrow-right"/>
                    </svg>
                </button>
                <button class="nav-buttons hover-effect" id="edit-btn">
                    <svg class="svg-class">
                        <use xlink:href="#edit">
                        </use>
                    </svg>
                </button>
                <button class=""id="submit-btn" style="display: none;">Save Changes</button>
                <button id="cancel-btn" style="display: none;"> Cancel! </button>
                <button class="nav-buttons hover-effect" id="delete-btn" >
                    <svg class="svg-class">
                        <use xlink:href="#garbage"></use>
                    </svg>
                </button>
        </div>
        </div>

    </div>


    {% else %}


     <form action="{% url 'home' %}" method="get">
        <button type="submit"><--</button>

    </form>


       <form action="{% url 'createPage' %}" method="get">
        <button type="submit">Create Cards</button>
    </form>




    {% endif %}

<script>

    document.addEventListener('DOMContentLoaded', function(){
        var definitions = document.querySelectorAll('#definitionCarousel li');


        var currentIndex = 0;
        var editingDef = false;
        var editButton = document.getElementById('edit-btn');
        var originalWordText, originalDefinition, originalSentence;


        function addQuotesToSentenceUse() {
            var definitions = document.querySelectorAll('#definitionCarousel li');
            definitions.forEach(function(definition) {
                var sentenceUseElement = definition.querySelector('p[style="font-style: italic;"]');
                if (sentenceUseElement) {
                    var sentenceUseText = sentenceUseElement.textContent;
                    // Check if the sentence use does not start and end with quotation marks
                    if (!(sentenceUseText.startsWith('"') && sentenceUseText.endsWith('"')) && !(sentenceUseText.length === 0)) {
                        // Add quotation marks around the sentence use
                        sentenceUseElement.textContent = '"' + sentenceUseText + '"';
                    }
                }});
        }

        function showDefinition(index){
            var shownDefinitionId; // Variable to store the ID of the definition that will be shown

            definitions.forEach(function(definition, i){
                // Determine if this definition should be shown
                if (i === index) {
                    definition.style.display = 'block';
                    shownDefinitionId = definition.id; // Store the ID of the definition that will be shown
                    let currentIndexNew = index + 1;
                    document.getElementById('counter').textContent = currentIndexNew + ' / ' + definitions.length;
                } else {
                    definition.style.display = 'none';
                }
                addQuotesToSentenceUse();
            });
    // Update currentDefinitionId after the loop, using the ID of the definition that was shown
            document.getElementById('currentDefinitionId').value = shownDefinitionId;
        }

        document.getElementById('definition-div').addEventListener('click', function(event){
           if(event.target.matches('#prevBtn')){

               if(editingDef === false)
               {
               console.log('Previous button clicked.');
               currentIndex = currentIndex > 0 ? currentIndex - 1 : definitions.length - 1;
               console.log(currentIndex);
               showDefinition(currentIndex);
               var defId = document.getElementById('currentDefinitionId').value;
               console.log("Updated ID: " + defId);

               }
               else
               {
                   alert("Please finish editing before switching!");
               }

           }
           else if (event.target.matches('#nextBtn')){
               if (editingDef === false)
               {
                   console.log('Next button clicked.');
                   currentIndex = (currentIndex + 1) % definitions.length;
                   console.log(currentIndex);
                   showDefinition(currentIndex);
                   var defId = document.getElementById('currentDefinitionId').value;
                   console.log("Updated ID: " + defId);
               }else
               {
                   alert("Please finish editing before switching!");
               }

           }
           else if(event.target.matches('#edit-btn'))
           {
               editingDef = true;
               var defId = document.getElementById('currentDefinitionId').value;
               var formattedId = defId.replace(/[^0-9]/g, "");
               var wordText = document.getElementById('word-text');
               var definition = document.getElementById('def-text-' + formattedId);
               var sentence = document.getElementById('sentence-use-' + formattedId);
               originalWordText = wordText.textContent;
               originalDefinition = definition.textContent;
               originalSentence = sentence.textContent;



               if (wordText && definition && sentence) {
                   wordText.contentEditable = wordText.contentEditable === 'false' ? 'true' : 'false';
                   definition.contentEditable = definition.contentEditable === 'false' ? 'true' : 'false';
                   sentence.contentEditable = sentence.contentEditable === 'false' ? 'true' : 'false';
               } else {
                   console.error('One or more elements could not be found.');
               }


               editButton.style.display = editButton.style.display === 'none' ? 'inline' : 'none';
               document.getElementById('cancel-btn').style.display = document.getElementById('cancel-btn').style.display === 'inline' ? 'none' : 'inline';
               document.getElementById('submit-btn').style.display = document.getElementById('submit-btn').style.display === 'inline' ? 'none' : 'inline';


           }
           else if(event.target.matches('#cancel-btn')) {


               editingDef = false;
               var defId = document.getElementById('currentDefinitionId').value;
               var formattedId = defId.replace(/[^0-9]/g, "");
               var wordText = document.getElementById('word-text');
               var definition = document.getElementById('def-text-' + formattedId);
               var sentence = document.getElementById('sentence-use-' + formattedId);
               wordText.textContent = originalWordText;
               definition.textContent = originalDefinition;
               sentence.textContent = originalSentence;


               wordText.contentEditable = wordText.contentEditable === 'true' ? 'false' : 'true';
               definition.contentEditable = definition.contentEditable === 'true' ? 'false' : 'true';
               sentence.contentEditable = sentence.contentEditable === 'true' ? 'false' : 'true';
               editButton.style.display = editButton.style.display === 'none' ? 'inline' : 'none';
               document.getElementById('cancel-btn').style.display = document.getElementById('cancel-btn').style.display === 'inline' ? 'none' : 'inline';
               document.getElementById('submit-btn').style.display = document.getElementById('submit-btn').style.display === 'inline' ? 'none' : 'inline';



           }
           else if(event.target.matches('#submit-btn'))
           {
               var defId = document.getElementById('currentDefinitionId').value;
               var formattedId = defId.replace(/[^0-9]/g, "");
               var wordText = document.getElementById('word-text').textContent;

               //I was getting this error
               // line 261, in query
               //  _mysql.connection.query(self, query)
               //  django.db.utils.DataError: (1406, "Data too long for column 'sentence_use' at row 1")
               // Basically the .textContent was getting all the text from the paragraph including all the white space
               // and when it was put into the database it would include all of the white space as well.
               // So we used .replace(/\s+/g, ' ').trim() to remove all of the whitespace from the text so that
               // essentially it only gets the text that we want and condenses it all down to something that we
               // can easily put into the database without any issues.

               var definitionText = document.getElementById('def-text-' + formattedId).textContent.replace(/\s+/g, ' ').trim();
               var sentenceText = document.getElementById('sentence-use-' + formattedId).textContent.replace(/\s+/g, ' ').trim();
               var cardId = "{{ card.id }}";


               $.ajax({
                   url: '/' + cardId + '/editWord/',
                   type: 'POST',
                   data: {
                       'card-id': cardId,
                       'def-id': formattedId,
                       'word-text': wordText,
                       'def-text': definitionText,
                       'sentence-use': sentenceText,
                       'csrfmiddlewaretoken': '{{ csrf_token }}'
                   },
                    success: function(response){
                        var successMessageElement = document.getElementById('success-message');

                        successMessageElement.textContent = 'Saved Successfully!';
                        successMessageElement.style.display = 'block';
                        successMessageElement.classList.add('success');

                        setTimeout(function(){
                            successMessageElement.style.display = 'none';
                            successMessageElement.textContent = '';

                        }, 3000);


                        editingDef = false;
                        document.getElementById('word-text').contentEditable = document.getElementById('word-text').contentEditable === 'true' ? 'false' : 'true';
                        document.getElementById('def-text-' + formattedId).contentEditable = document.getElementById('def-text-' + formattedId).contentEditable === 'true' ? 'false' : 'true';
                        document.getElementById('sentence-use-' + formattedId).contentEditable = document.getElementById('sentence-use-' + formattedId).contentEditable === 'true' ? 'false' : 'true';
                        document.getElementById('edit-btn').style.display = document.getElementById('edit-btn').style.display === 'none' ? 'inline' : 'none';
                        document.getElementById('cancel-btn').style.display = document.getElementById('cancel-btn').style.display === 'inline' ? 'none' : 'inline';
                        document.getElementById('submit-btn').style.display = document.getElementById('submit-btn').style.display === 'inline' ? 'none' : 'inline';
                        addQuotesToSentenceUse();

                    },
                    error: function(jqXHR, textStatus, errorThrown){
                       alert('There was a problem with the request: ' + textStatus + ' - ' + errorThrown);
                    }
               });

           }
           else if(event.target.matches('#delete-btn'))
           {
               var cardId = "{{ card.id }}";


               $.ajax({
                   url: '/deleteCard/' + cardId + '/',
                   type: 'POST',
                   data:{
                       'card_id': cardId,
                       'csrfmiddlewaretoken': '{{ csrf_token }}',
                   },
                   success: function(response)
                   {
                         if (response.redirect_url) {
                            window.location.href = response.redirect_url;
                         }

                   },
                   error: function(jqXHR, textStatus, errorThrown){
                       alert('There was a problem with the request: ' + textStatus + ' - ' + errorThrown)
                   }



               })



           }

        });
        showDefinition(currentIndex);
    })


</script>


</body>
</html>