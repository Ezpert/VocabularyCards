<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/wordSearch.css'%}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


</head>
<body>
<svg style="display: none;">
    <symbol id="arrow-left" viewBox="0 0 24 24">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M19.9961 11.0076L6.99614 11.0076L12.5627 5.10988C13.0638 4.49442 13.1469 3.81523 12.6791 3.33739C12.2268 2.87542 11.4963 2.89791 11.044 3.35988L3.33994 11.1802C2.88766 11.6422 2.88766 12.3884 3.33994 12.8504L11.0324 20.6539C11.4847 21.1159 12.2077 21.1111 12.69 20.6803C13.188 20.2354 13.0048 19.4402 12.5667 18.9341L6.99614 13.0084H19.9961C20.634 13.0084 20.9961 12.652 20.9961 12.0005C20.9961 11.349 20.634 11.0076 19.9961 11.0076Z"></path>
    </symbol>
    <symbol id="arrow-right" viewBox="0 0 24 24">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M4.00098 12.9963H17.001L11.4344 18.894C10.9333 19.5095 10.8502 20.1887 11.318 20.6665C11.7703 21.1285 12.5009 21.106 12.9531 20.644L20.6572 12.8237C21.1095 12.3618 21.1095 11.6155 20.6572 11.1536L12.9647 3.34999C12.5125 2.88802 11.7894 2.89278 11.3071 3.32361C10.8091 3.76851 10.9923 4.56372 11.4305 5.06982L17.001 10.9955L4.00098 10.9955C3.36316 10.9955 3.00098 11.3519 3.00098 12.0034C3.00098 12.6549 3.36316 12.9963 4.00098 12.9963Z"></path>
    </symbol>
</svg>


<div class="container-div">
    <form class="back-button-form" action="{% url 'createPage' %}" method="get">
            <button class="back-button" type="submit">
                <svg id="back-button-svg" class="svg-class">
                    <use xlink:href="#arrow-left"/>
                </svg>
            </button>
    </form>

    {% if definitions_and_examples %}

    <div id="success-message" style="display: none;">

    </div>

    <div id="definitionDiv" class="card-container-div">

        <div id="definitionCarousel" class="card-info-div">

            <ol class="ordered-list-div">
                {% for item in definitions_and_examples %}
                    {% if forloop.first %}
                    <h2 style="margin: 70px 0px 0px 0px;"id="word">{{ item.word }}</h2>
                    {% endif %}
                    <li id="definition-{{ forloop.counter }}" style="display: none;" >
                        <p id="definition-text-{{ forloop.counter }}"> {{ item.definition }} </p>
                        {% if item.example == "No example Provided" %}

                            <div class="loading-bar-div"></div>
                            <p id="definition-text-{{ forloop.counter }}-example" style="font-style:italic; display: none;">{{ item.example }}</p>
                        {% else %}
                            <p id="definition-text-{{ forloop.counter }}-nexample" style="font-style:italic;">{{ item.example }}</p>
                        {% endif %}
                            <input id="addWordBtn-{{ forloop.counter }}" type="image" src="{% static 'images/saveicon.png' %}" style="display: block;"/>
                    </li>
                {% endfor %}
            </ol>
            <input type="hidden" id="currentDefinitionId" value="">
        </div>

        <div class="nav-div">
                <button class="nav-buttons"id="prevBtn">
                    <svg class="svg-class">
                      <use xlink:href="#arrow-left" />
                    </svg>
                </button>
                <h4 id="counter">  / {{ definitions_and_examples|length }}</h4>
                <button class="nav-buttons" id="nextBtn">
                    <svg class="svg-class">
                        <use xlink:href="#arrow-right"/>
                    </svg>
                </button>
        </div>

    </div>
    {% else %}
        <p>Definitions not found!</p>
    {% endif %}
</div>

<script>



    document.addEventListener('DOMContentLoaded', function(){
        var definitions = document.querySelectorAll('#definitionCarousel li')
        var currentIndex = 0;
        var currentDefinitionId = '';


           function addQuotesToSentenceUse() {
            var definitions = document.querySelectorAll('#definitionCarousel li');
            definitions.forEach(function(definition, index) {
                 var sentenceUseElement = definition.querySelector(`#definition-text-${index + 1}-example, #definition-text-${index + 1}-nexample`);
                if (sentenceUseElement) {
                    var sentenceUseText = sentenceUseElement.textContent;
                    // Check if the sentence use does not start and end with quotation marks
                    if (!(sentenceUseText.startsWith('"') && sentenceUseText.endsWith('"')) && !(sentenceUseText.length === 0)) {
                        // Add quotation marks around the sentence use
                        sentenceUseElement.textContent = '"' + sentenceUseText + '"';
                    }
                }});
        }





        function makeSentence()
        {
            console.log('Sentence Example!');
            var definitionText = document.getElementById('definition-text-' + (currentIndex + 1)).textContent.replace(/\s+/g, ' ').trim();
            var sentence = document.getElementById('definition-text-' + (currentIndex + 1)  +'-example').textContent.replace(/\s+/g, ' ').trim().replace(/"/g, '');
            var word = document.getElementById('word').textContent.replace(/\s+/g, ' ').trim();



            $.ajax({
                url: '/makeSen/',
                type: 'POST',
                data: {
                    'word_example': word,
                    'definition_example': definitionText,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',

                },
                success: function(response){


                    console.log("Ajax Call: Success!");
                    console.log(response.new_sentence);


                    console.log(document.getElementById('definition-text-' + (currentIndex + 1)  +'-example').textContent);
                    document.getElementById('definition-text-' + (currentIndex + 1)  +'-example').textContent = response.new_sentence;
                    document.getElementById('definition-text-' + (currentIndex + 1)  +'-example').style.display = 'block';
                    addQuotesToSentenceUse();
                },
                error: function(jqXHR, textStatus, errorThrown)
                {
                    alert('There was a problem with the request: ' + textStatus + ' - ' + errorThrown);
                }


            })



        }

        function checkConditionAndMakeAjaxCall(element) {
               console.log('Condition Function called!');
               var bool1 = element.style.display === 'block';
               try{
                   var sentence = document.getElementById('definition-text-' + (currentIndex + 1)  +'-example').textContent;

               }catch(TypeError)
               {
                   console.log("Invalid Sentence Error Caught!")
                   var sentence = document.getElementById('definition-text-' + (currentIndex + 1)  +'-nexample').textContent;

               }

               var bool2 = sentence === 'No example Provided' || sentence === '"No example Provided"';
               console.log("Display === block: "+bool1);
               console.log("Text is === 'No example Provided' : " + bool2);
               console.log("Sentence: " + sentence);


          if (bool1 && bool2) {
              console.log('Condition Passed!');
                makeSentence();
            }
        }

        function showDef(index){
            var shownDefinitionId;

            definitions.forEach(function(definition,i){
                if(i === index){
                    definition.style.display = 'block';
                    shownDefinitionId = definition.id;
                    var currentIndexNew = currentIndex + 1;
                    document.getElementById('counter').textContent = document.getElementById('counter').textContent.replace(/^./, currentIndexNew);
                    checkConditionAndMakeAjaxCall(definition);

                } else{
                    definition.style.display = 'none';
                }
                  addQuotesToSentenceUse();

            });

            document.getElementById('currentDefinitionId').value = shownDefinitionId;
        }
        document.getElementById('definitionDiv').addEventListener('click', function(event){
            if(event.target.matches('#prevBtn')){
                console.log('Prev button Clicked');
                console.log(currentIndex);
                currentIndex = currentIndex > 0 ? currentIndex - 1 : definitions.length - 1;
                console.log(currentIndex);
                 if (currentDefinitionId !== definitions[currentIndex].id) {
                    showDef(currentIndex);
                    currentDefinitionId = definitions[currentIndex].id;
                }

            }else if(event.target.matches('#nextBtn')){
                console.log('Next button Clicked');
                currentIndex = (currentIndex + 1) % definitions.length;
                console.log(currentIndex);
                if (currentDefinitionId !== definitions[currentIndex].id) {
                    showDef(currentIndex);
                    currentDefinitionId = definitions[currentIndex].id;
                }

            }else if(event.target.matches('#addWordBtn-' + (currentIndex + 1)) || event.target.matches('#naddWordBtn')){
                console.log('Add word button Clicked');
                var word = document.getElementById('word').textContent.replace(/\s+/g, ' ').trim();
                var definitionText = document.getElementById('definition-text-' + (currentIndex + 1)).textContent.replace(/\s+/g, ' ').trim();
                try{
                   var sentence = document.getElementById('definition-text-' + (currentIndex + 1)  +'-example').textContent.replace(/\s+/g, ' ').trim().replace(/"/g, '');

               }catch(TypeError)
               {
                   console.log("Invalid Sentence Error Caught!")
                   var sentence = document.getElementById('definition-text-' + (currentIndex + 1)  +'-nexample').textContent.replace(/\s+/g, ' ').trim().replace(/"/g, '');

               }

                $.ajax({
                    url: '/searchAdd/',
                    type: 'POST',
                    data:{
                        'word': word,
                        'definition': definitionText,
                        'sentence': sentence,
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                    },
                    success: function(response){

                        var successMessageElement = document.getElementById('success-message');
                        var img = document.getElementById('addWordBtn-' + (currentIndex + 1));

                        successMessageElement.textContent = 'Saved Successfully!';
                        successMessageElement.style.display = 'block';
                        successMessageElement.classList.add('success');

                        setTimeout(function(){
                            successMessageElement.style.display = 'none';
                            successMessageElement.textContent = '';

                        }, 1000);

                        img.setAttribute('src', "{% static 'images/checkmark.png' %}");
                        img.disabled = true;
                        $(img).off('click');


                    },
                    error: function(jqXHR, textStatus, errorThrown){
                          alert('There was a problem with the request: ' + textStatus + ' - ' + errorThrown);
                    }


                })
            }
        });
        showDef(currentIndex);
    })
</script>
</body>
</html>